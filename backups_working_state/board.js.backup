/* Caseboard Board — professional colleague view, same as TV but no videos/ticker */

const API = '/tv/cases';
const POLL_MS = 60_000;
const SCROLL_SPEED = 0.35;
const PAUSE_AT_END_MS = 3000;
// Force display timezone for TV (Central Time by default)
const TIME_ZONE = 'America/Chicago';

const clockEl = () => document.getElementById('clock');
const dateEl = () => document.getElementById('date');
const rowsEl  = () => document.getElementById('rows');
const scrollerEl = () => document.getElementById('caseScroller');
const liveIndicatorEl = () => document.getElementById('liveIndicator');

// paging for very long lists
let pageIndex = 0;
const PAGE_GROUP_COUNT = 3; // legacy: groups per page (unused for display)
const PAGE_ROWS_COUNT = 14;  // number of case rows per page
let pageTimer = null;
let pagePause = false;
let progressRAF = null;
const priorityEl = () => null;
const miniUpcomingEl = () => null;

const metricEl = id => document.getElementById(id);
const totalLabelEl = () => document.getElementById('metricTotalLabel');
const totalHintEl = () => document.getElementById('metricTotalHint');

let data = { cases: [] };
let rafId = null;
let autoscrollState = { dir: 1, pauseUntil: 0 };

const TEXT_FIXES = [];
const HTML_ESC = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" };

const GROUPS = [
  { key: 'overdue', label: 'Overdue', order: 0 },
  { key: 'today',   label: 'Due Today', order: 1 },
  { key: 'week',    label: 'Due This Week', order: 2 },
  { key: 'next',    label: 'Next 7 Days', order: 3 },
  { key: 'later',   label: 'Later', order: 4 },
  { key: 'nodue',   label: 'No Due Date', order: 5 },
];

const MS_PER_DAY = 24 * 60 * 60 * 1000;

function normalizeText(v){ if(v==null) return ''; let s=String(v); for(const [re,r] of TEXT_FIXES) s=s.replace(re,r); return s.trim(); }
function display(v,f='—'){ const s=normalizeText(v); return s? s : f; }
function escapeHtml(v){ return display(v,'').replace(/[&<>'"]/g,ch=>HTML_ESC[ch]); }
function escapeAttr(v){ return escapeHtml(v).replace(/`/g,'&#96;'); }
function fmtDate(dt){ if(!dt) return '—'; const d=new Date(dt); if(Number.isNaN(d)) return '—'; return d.toLocaleDateString(undefined,{month:'short',day:'2-digit',year:'numeric'}); }

function badge(status){
  const normalized = normalizeText(status);
  if(!normalized) return '<span class="badge none">No status</span>';
  const s = normalized.toLowerCase();
  const cls =
    s.includes('prospect') ? 'prospect' :
    s.includes('active') ? 'active' :
    s.includes('pre') ? 'pre-filing' :
    s.includes('file') ? 'filed' :
    s.includes('close') ? 'closed' :
    s.includes('settle') ? 'settlement' :
    s.includes('appeal') ? 'appeal' : 'open';
  return `<span class="badge ${cls}">${escapeHtml(normalized)}</span>`;
}

function needsAttention(c){
  const note = normalizeText(c?.attention || '');
  return note && note.toLowerCase().includes('need');
}
function attentionClass(c){
  const a = (c?.attention || '').toLowerCase();
  if(a === 'needs_attention') return 'att-needs';
  if(a === 'waiting') return 'att-wait';
  return '';
}
function parseDueDate(c){ if(!c||!c.next_due) return null; const d=new Date(c.next_due); return Number.isNaN(d)? null : d; }
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }

function categorizeCase(c){
  const dueDate = parseDueDate(c);
  if(!dueDate) return { group:'nodue', accent:'nodue', pillLabel:'No deadline set', dueDate:null, diffDays:null, sortValue: Number.POSITIVE_INFINITY };
  const today = startOfDay(new Date());
  const due = startOfDay(dueDate);
  const diffDays = Math.round((due - today)/MS_PER_DAY);
  if(diffDays < 0) return { group:'overdue', accent:'overdue', pillLabel: Math.abs(diffDays)===1?'1 day overdue':`${Math.abs(diffDays)} days overdue`, dueDate:due, diffDays, sortValue: due.getTime() };
  if(diffDays === 0) return { group:'today', accent:'today', pillLabel:'Due today', dueDate:due, diffDays, sortValue: due.getTime() };
  if(diffDays === 1) return { group:'week', accent:'week', pillLabel:'Due tomorrow', dueDate:due, diffDays, sortValue: due.getTime() };
  if(diffDays <= 3) return { group:'week', accent:'week', pillLabel:`Due in ${diffDays} days`, dueDate:due, diffDays, sortValue: due.getTime() };
  if(diffDays <= 7) return { group:'next', accent:'next', pillLabel:`Due in ${diffDays} days`, dueDate:due, diffDays, sortValue: due.getTime() };
  return { group:'later', accent:'later', pillLabel:`Due in ${diffDays} days`, dueDate:due, diffDays, sortValue: due.getTime() };
}

function priorityIcon(info){ return ''; }
function priorityFlag(info){ return ''; }
function duePill(info){
  if(!info || !info.dueDate) return '<span class="due-pill nodue"><strong>No deadline</strong><span>Set date</span></span>';
  return `<span class="due-pill ${info.accent}"><strong>${escapeHtml(info.pillLabel)}</strong><span>${fmtDate(info.dueDate)}</span></span>`;
}
function focusText(value){
  const text = display(value);
  if(!text || text==='—') return '<span class="muted focus-text">No focus logged</span>';
  return `<span class="focus-text">${escapeHtml(text)}</span>`;
}

function initials(name){ const parts=String(name||'').trim().split(/[\s,]+/).filter(Boolean); const first=parts[0]?.[0]||''; const last=parts[parts.length-1]?.[0]||''; return (first+last).toUpperCase(); }
function hashColor(name){ let h=0; const s=60, l=62; const str=String(name||''); for(let i=0;i<str.length;i++){ h=(h*31 + str.charCodeAt(i))>>>0; } return `${h%360}, ${s}%, ${l}%`; }

function row(c, info){
  const classes = ['trow','row','tv-row',info.accent];
  const att = attentionClass(c);
  if(att) classes.push(att);
  if (c.top_priority) classes.push('top-priority');
  const client = display(c.client_name);
  const rawCaseNumber = (c.case_number ?? '').toString().trim();
  const caseName = display(c.case_name);
  const caseType = display(c.case_type);
  const county = display(c.county);

  const focus = c.current_focus ?? c.current_task;
  const caseNumberLabel = rawCaseNumber ? `${rawCaseNumber}` : '';
  const ribbon = c.top_priority ? '<span class="priority-ribbon" aria-hidden="true"></span>' : '';
  const star = c.top_priority ? '<span class="priority-mark" title="Top Priority" aria-hidden="true">★</span>' : '';
  return `
  <div class="${classes.join(' ')}" data-group="${info.group}">
    ${ribbon}
    <div class="cell col-client" title="${escapeAttr(client)}">
      <div class="client-line">
        ${star}<span class="client-name">${escapeHtml(client)}</span>
      </div>
    </div>
    <div class="cell col-case-name" title="${escapeAttr(caseName)}">
      <span class="case-name">${escapeHtml(caseName)}</span>
      ${rawCaseNumber ? `<span class="case-num" title="${escapeAttr(rawCaseNumber)}">${escapeHtml(rawCaseNumber)}</span>` : ''}
    </div>
    <div class="cell col-type" title="${escapeAttr(caseType)}">${escapeHtml(caseType)}</div>
    <div class="cell col-status">${badge(c.status)}</div>
    <div class="cell col-focus" title="${escapeAttr(display(focus))}">${focusText(focus)}</div>
    <div class="cell col-county" title="${escapeAttr(county)}">${escapeHtml(county)}</div>
  </div>`;
}

function groupRow(group,count){ return `<div class="group-row ${group.key}"><span class="group-name">${group.label}</span><span class="group-count">${count}</span></div>`; }

function groupCases(list){
  const buckets = new Map(GROUPS.map(g=>[g.key,{...g,cases:[]}]));
  for(const c of list){
    const info = categorizeCase(c);
    const bucket = buckets.get(info.group) || buckets.get('nodue');
    bucket.cases.push({case:c, info});
  }
  const grouped = Array.from(buckets.values()).sort((a,b)=>a.order-b.order);
  for(const g of grouped){
    g.cases.sort((a,b)=> a.info.sortValue - b.info.sortValue || a.info.diffDays - b.info.diffDays || 0);
  }
  return grouped.filter(g=>g.cases.length>0);
}

function pluralizeCase(n){ return n===1?'1 case':`${n} cases`; }

function updateMetrics(grouped){
  const counts = { overdue:0, today:0, week:0, next:0, later:0, nodue:0 };
  let total = 0;
  for(const g of grouped){ const c=g.cases.length; counts[g.key]=c; total+=c; }
  const weekTotal = (counts.week||0) + (counts.next||0);
  const metrics = { metricOverdue: counts.overdue||0, metricToday: counts.today||0, metricWeek: weekTotal, metricTotal: total };
  for(const [id,val] of Object.entries(metrics)){ const el=metricEl(id); if(el) el.textContent = val; }
  const tl = totalLabelEl(); if(tl) tl.textContent = pluralizeCase(total);
  const hint = totalHintEl();
  if(hint){
    const stamp = data?.generated_at ? new Date(data.generated_at) : null;
    hint.textContent = (stamp && !Number.isNaN(stamp)) ? `Updated ${stamp.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}` : 'Tracking on this board';
  }
}

function renderPriority(grouped){}
function renderMiniUpcoming(grouped){}

function sizeBoard(){
  const scroller = scrollerEl(); if(!scroller) return;
  const headerH = document.querySelector('.header')?.offsetHeight || 0;
  const metricsH = document.querySelector('.tv-insights')?.offsetHeight || 0;
  const padding = 140;
  const max = Math.max(window.innerHeight - headerH - metricsH - padding, 360);
  scroller.style.maxHeight = `${max}px`;
}

function animateProgress(duration){
  cancelAnimationFrame(progressRAF);
  const bar = document.getElementById('pageProgress'); if(!bar) return;
  const start = performance.now();
  const step = (ts)=>{
    const t = Math.min(1, (ts - start)/duration);
    bar.style.width = `${t*100}%`;
    progressRAF = requestAnimationFrame(step);
  };
  bar.style.width = '0%';
  progressRAF = requestAnimationFrame(step);
}

function render(options={}){
  const list = Array.isArray(data?.cases) ? data.cases : [];
  const grouped = groupCases(list);
  const container = rowsEl();
  if(!grouped.length){
    container.innerHTML = '<div class="empty-state tv-empty">No active cases on the board.</div>';
    updateMetrics(grouped); renderPriority(grouped); renderMiniUpcoming(grouped); sizeBoard(); return;
  }

  // Flatten grouped cases for a single minimalist list (no section headers)
  const items = [];
  for(const g of grouped){ for(const item of g.cases){ items.push(item); } }
  // Build paged rows by fixed row count
  const pages = [];
  for(let i=0;i<items.length;i+=PAGE_ROWS_COUNT){ pages.push(items.slice(i,i+PAGE_ROWS_COUNT)); }
  if(pageIndex >= pages.length) pageIndex = 0;
  const page = pages.length ? pages[pageIndex] : [];
  // Build HTML in normal flow with staggered rows (no absolute layers to avoid clipping)
  container.classList.add('row-stagger');
  container.innerHTML = page.map(({case:c,info}, idx)=>`<div class="row-wrap" style="animation-delay:${idx*120}ms">${row(c,info)}</div>`).join('');
  container.classList.add('fade-in');
  setTimeout(()=>container.classList.remove('fade-in'), 1200);

  updateMetrics(grouped); renderPriority(grouped); renderMiniUpcoming(grouped); sizeBoard();

  // Page timing: 6–10s based on rows
  // Double dwell for slower pacing
  const dwell = Math.min(40000, Math.max(24000, page.length * 2800));
  animateProgress(dwell);

  if(pageTimer) clearTimeout(pageTimer);
  pageTimer = setTimeout(()=>{
    pagePause = true; // brief pause at end
    setTimeout(()=>{
      pagePause = false;
      pageIndex = (pageIndex + 1) % Math.max(pages.length,1);
      render({preserveTicker:true});
      resetScroll();
    }, 1000);
  }, dwell);
}

async function load(){
  try {
    const res = await fetch(API, { cache: 'no-store' });
    const json = await res.json();
    data = json || { cases: [] };
    // Do not reset the ticker when case data updates
    render({preserveTicker:true});
    // keep case scroller at top on page changes only
    resetScroll();
    
    // Update live indicator
    const indicator = liveIndicatorEl();
    if(indicator) {
      indicator.textContent = '● LIVE';
      indicator.style.color = '#4ade80'; // green
      // Flash the indicator briefly
      indicator.style.opacity = '0.5';
      setTimeout(() => {
        indicator.style.opacity = '1';
      }, 200);
    }
  } catch(err) {
    console.error('Failed to load cases:', err);
    // Update live indicator to show offline status
    const indicator = liveIndicatorEl();
    if(indicator) {
      indicator.textContent = '● OFFLINE';
      indicator.style.color = '#ef4444'; // red
    }
  }
}

function formatHeaderDate(d){ return d.toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric', timeZone: TIME_ZONE}); }
function tickClock(){
  const now = new Date();
  const c = clockEl(); if(c) c.textContent = now.toLocaleTimeString([], { hour:'numeric', minute:'2-digit', second:'2-digit', timeZone: TIME_ZONE });
  const d = dateEl(); if(d) d.textContent = formatHeaderDate(now);
}

function resetScroll(){ const el=scrollerEl(); if(!el) return; el.scrollTop=0; autoscrollState={dir:1, pauseUntil:0}; }
function autoScroll(ts){
  const el = scrollerEl(); if(!el){ rafId=requestAnimationFrame(autoScroll); return; }
  const max = el.scrollHeight - el.clientHeight;
  if(max<=0){ rafId=requestAnimationFrame(autoScroll); return; }
  if(ts < autoscrollState.pauseUntil){ rafId=requestAnimationFrame(autoScroll); return; }
  el.scrollTop += SCROLL_SPEED * autoscrollState.dir;
  if(el.scrollTop <= 0){ autoscrollState.dir=1; autoscrollState.pauseUntil = ts + PAUSE_AT_END_MS; }
  else if(el.scrollTop >= max - 1){ autoscrollState.dir=-1; autoscrollState.pauseUntil = ts + PAUSE_AT_END_MS; }
  rafId = requestAnimationFrame(autoScroll);
}

function onResize(){ sizeBoard(); }
function setThemeByTime(){
  const hour = new Date().getHours();
  const body = document.body;
  const mode = hour < 10 ? 'morning' : hour < 17 ? 'day' : hour < 21 ? 'evening' : 'night';
  body.setAttribute('data-theme', mode);
}

function init(){
  setThemeByTime(); setInterval(setThemeByTime, 10*60*1000);
  tickClock(); setInterval(tickClock,1000);
  load(); setInterval(()=>{ load(); }, POLL_MS);
  window.addEventListener('resize', onResize);
  try{ if(document.documentElement.requestFullscreen){ document.documentElement.requestFullscreen().catch(()=>{}); } }catch(e){}
}

document.addEventListener('DOMContentLoaded', init);